{% extends 'base.html' %}
{% load name_filters %}
{% block title %}Usuarios{% endblock %}
{% block content %}

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="page-title mb-1"><i class="bi bi-people me-2"></i>Usuarios</h1>
    <p class="text-muted mb-0">Administra roles, estado y oficina de los usuarios</p>
  </div>
  {% if request.user.is_authenticated and request.user.is_jefe %}
    <a class="btn btn-primary" href="/accounts/register/"><i class="bi bi-person-plus me-2"></i>Nuevo usuario</a>
  {% endif %}
  </div>

<!-- Quick filters -->
<div class="card mb-3">
  <div class="card-body py-2">
    <div class="d-flex flex-wrap align-items-center gap-2 small" id="userQuickFilters">
      {% with r=filters.role a=filters.active ap=filters.approved %}
      <div class="me-2 text-muted">Rol:</div>
      <div class="btn-group" role="group" aria-label="Filtro por rol">
        <a href="#" class="btn btn-light btn-sm" data-k="role" data-v="">Todos</a>
        <a href="#" class="btn btn-light btn-sm {% if r == 'JEFE' %}active{% endif %}" data-k="role" data-v="JEFE">Jefe</a>
        <a href="#" class="btn btn-light btn-sm {% if r == 'SUPERVISOR' %}active{% endif %}" data-k="role" data-v="SUPERVISOR">Supervisor</a>
        <a href="#" class="btn btn-light btn-sm {% if r == 'TECNICO' %}active{% endif %}" data-k="role" data-v="TECNICO">Técnico</a>
        <a href="#" class="btn btn-light btn-sm {% if r == 'UNASSIGNED' %}active{% endif %}" data-k="role" data-v="UNASSIGNED">Sin rol</a>
      </div>
      <div class="vr mx-2 d-none d-md-block"></div>
      <div class="me-2 text-muted">Aprobado:</div>
      <div class="btn-group" role="group" aria-label="Filtro aprobado">
        <a href="#" class="btn btn-light btn-sm {% if not ap %}active{% endif %}" data-k="approved" data-v="">Todos</a>
        <a href="#" class="btn btn-light btn-sm {% if ap == '1' %}active{% endif %}" data-k="approved" data-v="1">Sí</a>
        <a href="#" class="btn btn-light btn-sm {% if ap == '0' %}active{% endif %}" data-k="approved" data-v="0">No</a>
      </div>
      <div class="vr mx-2 d-none d-md-block"></div>
      <div class="me-2 text-muted">Activo:</div>
      <div class="btn-group" role="group" aria-label="Filtro activo">
        <a href="#" class="btn btn-light btn-sm {% if not a %}active{% endif %}" data-k="active" data-v="">Todos</a>
        <a href="#" class="btn btn-light btn-sm {% if a == '1' %}active{% endif %}" data-k="active" data-v="1">Sí</a>
        <a href="#" class="btn btn-light btn-sm {% if a == '0' %}active{% endif %}" data-k="active" data-v="0">No</a>
      </div>
      {% endwith %}
    </div>
  </div>
  <style>
    #userQuickFilters .btn.active{ background: #1f4ed8; color: #fff; box-shadow: 0 4px 12px rgba(31,78,216,.2); }
  </style>
</div>

<!-- Advanced filters (collapsible) -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filtros avanzados</h5>
    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#userAdvFilters" aria-expanded="{% if filters.q or filters.office %}true{% else %}false{% endif %}" aria-controls="userAdvFilters">
      <i class="bi bi-sliders me-1"></i> {% if filters.q or filters.office %}Ocultar{% else %}Mostrar{% endif %}
    </button>
  </div>
  <div id="userAdvFilters" class="collapse {% if filters.q or filters.office %}show{% endif %}">
    <div class="card-body">
      <form method="get">
        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label class="form-label fw-medium">Buscar</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input class="form-control" type="text" name="q" placeholder="Usuario o email" value="{{ filters.q }}">
            </div>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label fw-medium">Oficina</label>
            <select name="office" class="form-select">
              <option value="">Todas</option>
              {% for o in offices %}
                <option value="{{ o.id }}" {% if filters.office == o.id %}selected{% endif %}>{{ o.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-4 d-flex align-items-end">
            <div class="d-grid w-100">
              <button class="btn btn-primary" type="submit"><i class="bi bi-funnel-fill me-1"></i>Aplicar</button>
              <a class="btn btn-link mt-1 p-0" href="/accounts/users/">Limpiar filtros</a>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Users table -->
<div class="card">
  <div class="table-responsive">
    <table class="table table-hover mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>Usuario</th>
          <th>Email</th>
          <th>Aprobado</th>
          <th>Activo</th>
          <th>Rol</th>
          <th>Oficina</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
          <tr>
            <td class="fw-semibold">{{ u|first_last }}</td>
            <td class="text-muted">{{ u.email|default:"—" }}</td>
            <td>
              {% if u.approved %}
                <span class="badge bg-success-subtle text-success"><i class="bi bi-check-circle me-1"></i>Sí</span>
              {% else %}
                <span class="badge bg-warning-subtle text-warning"><i class="bi bi-exclamation-circle me-1"></i>No</span>
              {% endif %}
            </td>
            <td>
              {% if u.is_active %}
                <span class="badge bg-primary-subtle text-primary">Activo</span>
              {% else %}
                <span class="badge bg-secondary-subtle text-secondary">Inactivo</span>
              {% endif %}
            </td>
            <td>{{ u.get_role_display|default:"—" }}</td>
            <td>{{ u.office|default:"—" }}</td>
            <td class="text-center">
              <div class="btn-group btn-group-sm" role="group">
                <a class="btn btn-outline-primary" href="/accounts/users/{{u.id}}/" title="Editar"><i class="bi bi-pencil"></i></a>
                {% if not u.approved %}
                  <a class="btn btn-success" href="/accounts/approve/{{u.id}}/" title="Aprobar"><i class="bi bi-check2"></i></a>
                {% endif %}
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="7" class="text-center py-5">
              <div class="empty-state">
                <i class="bi bi-people"></i>
                <p class="mb-0">No hay usuarios para mostrar.</p>
                <small class="text-muted">Ajusta los filtros o registra un nuevo usuario.</small>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% if users.paginator.num_pages > 1 %}
<nav aria-label="Paginación" class="mt-4">
  <div class="d-flex justify-content-center">
    <ul class="pagination pagination-lg">
      {% if users.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ users.previous_page_number }}&role={{ filters.role }}&office={{ filters.office }}&approved={{ filters.approved }}&active={{ filters.active }}&q={{ filters.q }}"><i class="bi bi-chevron-left"></i></a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link"><i class="bi bi-chevron-left"></i></span></li>
      {% endif %}
      <li class="page-item active"><span class="page-link">{{ users.number }} de {{ users.paginator.num_pages }}</span></li>
      {% if users.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ users.next_page_number }}&role={{ filters.role }}&office={{ filters.office }}&approved={{ filters.approved }}&active={{ filters.active }}&q={{ filters.q }}"><i class="bi bi-chevron-right"></i></a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link"><i class="bi bi-chevron-right"></i></span></li>
      {% endif %}
    </ul>
  </div>
</nav>
{% endif %}

<script>
  // Quick filter buttons (role/approved/active) update URL params preserving others
  (function(){
    var root = document.getElementById('userQuickFilters');
    if (!root) return;
    root.addEventListener('click', function(e){
      var a = e.target.closest('a[data-k]');
      if (!a) return;
      e.preventDefault();
      var k = a.getAttribute('data-k');
      var v = a.getAttribute('data-v');
      var params = new URLSearchParams(window.location.search);
      if (v) { params.set(k, v); } else { params.delete(k); }
      params.delete('page');
      window.location.search = params.toString();
    });
  })();
</script>
{% endblock %}

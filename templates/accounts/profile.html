{% extends 'base.html' %}
{% block title %}Mi Perfil - Gestor de Servicios{% endblock %}
{% block content %}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="/" class="text-decoration-none">
        <i class="bi bi-house me-1"></i>Inicio
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Mi Perfil</li>
  </ol>
</nav>

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="page-title">
      <i class="bi bi-person-circle me-2"></i>Mi Perfil
    </h1>
    <p class="text-muted mb-0">Gestiona tu información personal y configuración de cuenta</p>
  </div>
  <div class="d-flex gap-2">
    <a href="/accounts/notifications/" class="btn btn-outline-primary">
      <i class="bi bi-bell me-2"></i>Notificaciones
    </a>
  </div>
</div>

<div class="row g-4">
  <!-- Panel de información del usuario -->
  <div class="col-lg-4">
    <div class="card shadow-sm border-0 sticky-top" style="top: 2rem;">
      <div class="card-body text-center p-4">
        <!-- Avatar -->
        <div class="mb-4">
          <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center" 
               style="width: 120px; height: 120px;">
            <i class="bi bi-person-fill text-white" style="font-size: 3rem;"></i>
          </div>
        </div>
        
        <!-- Información básica -->
        <h4 class="fw-bold mb-2">{{ user.get_full_name|default:user.username }}</h4>
        <p class="text-muted mb-3">@{{ user.username }}</p>
        
        <!-- Role y oficina -->
        <div class="mb-4">
          <span class="badge bg-primary fs-6 px-3 py-2 mb-2">
            <i class="bi bi-shield-check me-1"></i>
            {{ user.get_role_display }}
          </span>
          {% if user.office %}
            <div class="d-flex align-items-center justify-content-center text-muted">
              <i class="bi bi-building me-2"></i>
              <span>{{ user.office.name }}</span>
            </div>
          {% endif %}
        </div>

        <!-- Estadísticas -->
        <div class="row g-2">
          <div class="col-12">
            <div class="bg-light rounded p-3">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">
                  <i class="bi bi-calendar-check me-1"></i>
                  Miembro desde
                </span>
                <span class="fw-medium">{{ user.date_joined|date:"M Y" }}</span>
              </div>
            </div>
          </div>
          {% if user.id_type and user.id_number %}
            <div class="col-12">
              <div class="bg-light rounded p-3">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">
                    <i class="bi bi-card-text me-1"></i>
                    {{ user.get_id_type_display }}
                  </span>
                  <span class="fw-medium">{{ user.id_number }}</span>
                </div>
              </div>
            </div>
          {% endif %}
          {% if user.birth_date %}
            <div class="col-12">
              <div class="bg-light rounded p-3">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">
                    <i class="bi bi-calendar-heart me-1"></i>
                    Nacimiento
                  </span>
                  <span class="fw-medium">{{ user.birth_date|date:"d/m/Y" }}</span>
                </div>
              </div>
            </div>
          {% endif %}
          {% if user.phone %}
            <div class="col-12">
              <div class="bg-light rounded p-3">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">
                    <i class="bi bi-telephone me-1"></i>
                    Teléfono
                  </span>
                  <span class="fw-medium">{{ user.phone }}</span>
                </div>
              </div>
            </div>
          {% endif %}
          {% if user.is_tecnico %}
            <div class="col-12">
              <div class="bg-light rounded p-3">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">
                    <i class="bi bi-list-task me-1"></i>
                    Estado
                  </span>
                  <span class="badge bg-success">Activo</span>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario de edición -->
  <div class="col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-pencil-square me-2"></i>Información Personal
        </h5>
      </div>
      <div class="card-body p-4">
        <form method="post" class="needs-validation" novalidate>
          {% csrf_token %}
          
          <div class="row g-4">
            <!-- Información básica -->
            <div class="col-12">
              <h6 class="section-title">
                <i class="bi bi-person me-1"></i>Información Básica
              </h6>
            </div>

            <div class="col-md-6">
              <label for="{{ form.first_name.id_for_label }}" class="form-label fw-medium">
                <i class="bi bi-person me-1"></i>Nombre *
              </label>
              <input type="text" 
                     name="first_name" 
                     class="form-control" 
                     id="{{ form.first_name.id_for_label }}"
                     placeholder="Tu nombre"
                     value="{{ form.first_name.value|default:'' }}"
                     required>
              {% if form.first_name.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.first_name.errors.0 }}
                </div>
              {% endif %}
            </div>

            <div class="col-md-6">
              <label for="{{ form.last_name.id_for_label }}" class="form-label fw-medium">
                <i class="bi bi-person me-1"></i>Apellido *
              </label>
              <input type="text" 
                     name="last_name" 
                     class="form-control" 
                     id="{{ form.last_name.id_for_label }}"
                     placeholder="Tu apellido"
                     value="{{ form.last_name.value|default:'' }}"
                     required>
              {% if form.last_name.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.last_name.errors.0 }}
                </div>
              {% endif %}
            </div>

            <div class="col-12">
              <label for="{{ form.email.id_for_label }}" class="form-label fw-medium">
                <i class="bi bi-envelope me-1"></i>Correo Electrónico *
              </label>
              <input type="email" 
                     name="email" 
                     class="form-control" 
                     id="{{ form.email.id_for_label }}"
                     placeholder="tu@email.com"
                     value="{{ form.email.value|default:'' }}"
                     required>
              {% if form.email.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.email.errors.0 }}
                </div>
              {% endif %}
            </div>

            <!-- Información de contacto -->
            <div class="col-12">
              <hr class="my-4">
              <h6 class="section-title">
                <i class="bi bi-telephone me-1"></i>Información de Contacto
              </h6>
            </div>

            <div class="col-md-6">
              <label for="{{ form.phone.id_for_label }}" class="form-label fw-medium">
                <i class="bi bi-telephone me-1"></i>Teléfono
              </label>
              <input type="tel" 
                     name="phone" 
                     class="form-control" 
                     id="{{ form.phone.id_for_label }}"
                     placeholder="Tu número de teléfono"
                     value="{{ form.phone.value|default:'' }}">
              {% if form.phone.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.phone.errors.0 }}
                </div>
              {% endif %}
            </div>

            <div class="col-md-6">
              <label for="{{ form.id_type.id_for_label }}" class="form-label fw-medium">
                <i class="bi bi-card-list me-1"></i>Tipo de Identificación *
              </label>
              <select name="id_type" 
                      class="form-select" 
                      id="{{ form.id_type.id_for_label }}"
                      required>
                <option value="">Selecciona el tipo</option>
                {% for value, label in form.id_type.field.choices %}
                  <option value="{{ value }}" {% if form.id_type.value == value %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
              {% if form.id_type.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.id_type.errors.0 }}
                </div>
              {% endif %}
            </div>

            <div class="col-md-6">
              <label for="{{ form.id_number.id_for_label }}" class="form-label fw-medium">
                <i class="bi bi-card-text me-1"></i>Número de Identificación *
              </label>
              <input type="text" 
                     name="id_number" 
                     class="form-control" 
                     id="{{ form.id_number.id_for_label }}"
                     placeholder="Tu número de identificación"
                     value="{{ form.id_number.value|default:'' }}"
                     required>
              {% if form.id_number.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.id_number.errors.0 }}
                </div>
              {% endif %}
            </div>

            <!-- Información personal adicional -->
            <div class="col-12">
              <hr class="my-4">
              <h6 class="section-title">
                <i class="bi bi-calendar-heart me-1"></i>Información Personal
              </h6>
            </div>

            <div class="col-md-6">
              <label for="{{ form.birth_date.id_for_label }}" class="form-label fw-medium">
                <i class="bi bi-calendar me-1"></i>Fecha de Nacimiento
              </label>
              <input type="date" 
                     name="birth_date" 
                     class="form-control" 
                     id="{{ form.birth_date.id_for_label }}"
                     value="{{ form.birth_date.value|date:'Y-m-d'|default:'' }}">
              {% if form.birth_date.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.birth_date.errors.0 }}
                </div>
              {% endif %}
            </div>
          </div>

          {% if form.non_field_errors %}
            <div class="alert alert-danger mt-4" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>
              {{ form.non_field_errors.0 }}
            </div>
          {% endif %}

          <!-- Botones -->
          <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
            <button type="button" class="btn btn-secondary" onclick="window.history.back()">
              <i class="bi bi-x-circle me-2"></i>Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-circle me-2"></i>Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Card de información del sistema -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card border-0 bg-light">
      <div class="card-body p-4">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h5 class="fw-bold mb-2">
              <i class="bi bi-info-circle me-2"></i>Información de la Cuenta
            </h5>
            <p class="text-muted mb-0">
              Tu información personal está protegida y solo tú puedes modificarla. 
              Los cambios en tu rol o asignación de oficina deben ser realizados por un administrador.
            </p>
          </div>
          <div class="col-md-4 text-md-end">
            <div class="d-flex flex-column gap-2">
              <small class="text-muted">
                <i class="bi bi-shield-check me-1"></i>
                Información Segura
              </small>
              {% if user.approved %}
                <span class="badge bg-success">
                  <i class="bi bi-check-circle me-1"></i>Cuenta Aprobada
                </span>
              {% else %}
                <span class="badge bg-warning">
                  <i class="bi bi-clock me-1"></i>Pendiente Aprobación
                </span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .form-control:focus, .form-select:focus {
    border-color: var(--primary-blue-light);
    box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.15);
  }
  
  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  
  .section-title {
    color: var(--primary-blue);
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0.5rem;
  }

  .sticky-top {
    position: sticky;
  }

  @media (max-width: 992px) {
    .sticky-top {
      position: relative;
    }
  }
</style>
{% endblock %}
{% extends 'base.html' %}
{% block title %}Dashboard - Gestor de Servicios{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .stats-card {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
    border: none;
    color: white;
  }
  
  .stats-number {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .stats-label {
    font-size: 0.9rem;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .progress-wrapper {
    position: relative;
    margin-bottom: 1rem;
  }
  
  .progress {
    height: 8px;
    border-radius: 4px;
    background-color: #e9ecef;
  }
  
  .progress-bar {
    border-radius: 4px;
    transition: width 1s ease-in-out;
  }
  
  .chart-container {
    position: relative;
    height: 300px;
  }
  
  .metric-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(30, 64, 175, 0.1);
    transition: all 0.3s ease;
  }
  
  .metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 30px rgba(30, 64, 175, 0.15);
  }
  
  .metric-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary-blue);
    margin-bottom: 0.25rem;
  }
  
  .metric-label {
    color: #64748b;
    font-size: 0.875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .metric-icon {
    font-size: 2rem;
    color: var(--primary-blue-light);
    margin-bottom: 1rem;
  }

  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }
  
  .empty-state {
    padding: 3rem 1rem;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    transition: all 0.3s ease;
  }
  
  .card:hover .metric-card {
    transform: translateY(-2px);
  }
  
  .progress-bar {
    transition: width 2s ease-in-out;
  }
</style>
{% endblock %}

{% block content %}
<!-- Header con breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item active" aria-current="page">
      <i class="bi bi-house me-1"></i>Dashboard
    </li>
  </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="page-title mb-1">
      <i class="bi bi-speedometer2 me-2"></i>Dashboard
    </h1>
    <p class="text-muted mb-0">Vista general del sistema de requerimientos</p>
  </div>
  <div class="text-end">
    <small class="text-muted d-block">Última actualización</small>
    <small class="fw-medium">{{ "now"|date:"d/m/Y H:i" }}</small>
  </div>
</div>

<!-- Métricas principales -->
<div class="row g-4 mb-5">
  <div class="col-12 col-md-6 col-xl-3">
    <div class="card metric-card h-100">
      <div class="card-body text-center p-4">
        <i class="bi bi-files metric-icon"></i>
        <div class="metric-value">{{ total_tickets|default:0 }}</div>
        <div class="metric-label">Total Requerimientos</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6 col-xl-3">
    <div class="card metric-card h-100">
      <div class="card-body text-center p-4">
        <i class="bi bi-circle-fill metric-icon text-primary"></i>
        <div class="metric-value">{{ pending_count|default:0 }}</div>
        <div class="metric-label">Pendientes</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6 col-xl-3">
    <div class="card metric-card h-100">
      <div class="card-body text-center p-4">
        <i class="bi bi-clock-fill metric-icon text-warning"></i>
        <div class="metric-value">{{ in_progress_count|default:0 }}</div>
        <div class="metric-label">En Progreso</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6 col-xl-3">
    <div class="card metric-card h-100">
      <div class="card-body text-center p-4">
        <i class="bi bi-check-circle-fill metric-icon text-success"></i>
        <div class="metric-value">{{ completed_count|default:0 }}</div>
        <div class="metric-label">Completados</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Gráfico de estados -->
  <div class="col-12 col-lg-6">
    <div class="card h-100">
      <div class="card-header bg-white border-bottom-0 pb-0">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="mb-0">
            <i class="bi bi-pie-chart me-2 text-primary"></i>
            Distribución por Estado
          </h5>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#"><i class="bi bi-download me-2"></i>Exportar</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-printer me-2"></i>Imprimir</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card-body">
        {% if by_status %}
          <div class="chart-container mb-4">
            <canvas id="statusChart"></canvas>
          </div>
          
          <!-- Lista detallada -->
          <div class="status-details">
            {% for row in by_status %}
              <div class="d-flex align-items-center justify-content-between py-3 border-bottom">
                <div class="d-flex align-items-center">
                  {% if row.status == 'DRAFT' or row.status == 'ASSIGNED' %}
                    <div class="status-indicator bg-primary me-3"></div>
                    <span class="fw-medium">Abierto/Asignado</span>
                  {% elif row.status == 'IN_PROGRESS' %}
                    <div class="status-indicator bg-warning me-3"></div>
                    <span class="fw-medium">En Progreso</span>
                  {% elif row.status == 'PENDING_SUPPLIES' %}
                    <div class="status-indicator bg-info me-3"></div>
                    <span class="fw-medium">Pendiente Insumos</span>
                  {% elif row.status == 'COMPLETED' %}
                    <div class="status-indicator bg-success me-3"></div>
                    <span class="fw-medium">Completado</span>
                  {% elif row.status == 'CANCELLED' %}
                    <div class="status-indicator bg-danger me-3"></div>
                    <span class="fw-medium">Cancelado</span>
                  {% endif %}
                </div>
                <div class="text-end">
                  <div class="fw-bold fs-5 text-primary">{{ row.total }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state text-center py-5">
            <i class="bi bi-inbox display-1 text-muted mb-3"></i>
            <h6 class="text-muted">No hay datos disponibles</h6>
            <p class="text-muted mb-0">Los datos aparecerán cuando haya requerimientos en el sistema</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Gráfico por oficinas -->
  <div class="col-12 col-lg-6">
    <div class="card h-100">
      <div class="card-header bg-white border-bottom-0 pb-0">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="mb-0">
            <i class="bi bi-building me-2 text-primary"></i>
            Distribución por Oficina
          </h5>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#"><i class="bi bi-download me-2"></i>Exportar</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-eye me-2"></i>Ver detalles</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card-body">
        {% if by_office %}
          <div class="chart-container mb-4">
            <canvas id="officeChart"></canvas>
          </div>
          
          <!-- Lista con barras de progreso -->
          <div class="office-details">
            {% for row in by_office %}
              <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-geo-alt-fill text-primary me-2"></i>
                    <span class="fw-medium">{{ row.assigned_office__name|default:'Sin oficina asignada' }}</span>
                  </div>
                  <span class="badge bg-primary">{{ row.total }}</span>
                </div>
                <div class="progress-wrapper">
                  <div class="progress">
                    <div class="progress-bar bg-primary" 
                         role="progressbar" 
                         style="width: 0%"
                         aria-valuenow="{{ row.total }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state text-center py-5">
            <i class="bi bi-building display-1 text-muted mb-3"></i>
            <h6 class="text-muted">No hay datos por oficina</h6>
            <p class="text-muted mb-0">Los datos aparecerán cuando se asignen requerimientos a las oficinas</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Accesos Rápidos Modernos -->
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-white border-bottom-0">
        <h5 class="mb-0">
          <i class="bi bi-lightning me-2 text-primary"></i>
          Acciones Rápidas
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12 col-md-6 col-xl-3">
            <a href="/tickets/create/" class="btn btn-primary w-100 py-3 rounded-3 border-0">
              <div class="d-flex flex-column align-items-center">
                <i class="bi bi-plus-circle-fill mb-2" style="font-size: 1.5rem;"></i>
                <span class="fw-medium">Nuevo Requerimiento</span>
                <small class="opacity-75">Crear solicitud de servicio</small>
              </div>
            </a>
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <a href="/tickets/" class="btn btn-outline-primary w-100 py-3 rounded-3">
              <div class="d-flex flex-column align-items-center">
                <i class="bi bi-list-task mb-2" style="font-size: 1.5rem;"></i>
                <span class="fw-medium">Ver Requerimientos</span>
                <small class="opacity-75">Gestionar solicitudes</small>
              </div>
            </a>
          </div>
          {% if request.user.is_jefe %}
            <div class="col-12 col-md-6 col-xl-3">
              <a href="/accounts/users/" class="btn btn-outline-secondary w-100 py-3 rounded-3">
                <div class="d-flex flex-column align-items-center">
                  <i class="bi bi-people-fill mb-2" style="font-size: 1.5rem;"></i>
                  <span class="fw-medium">Gestionar Usuarios</span>
                  <small class="opacity-75">Administrar personal</small>
                </div>
              </a>
            </div>
            <div class="col-12 col-md-6 col-xl-3">
              <a href="/oficinas/" class="btn btn-outline-secondary w-100 py-3 rounded-3">
                <div class="d-flex flex-column align-items-center">
                  <i class="bi bi-building-fill mb-2" style="font-size: 1.5rem;"></i>
                  <span class="fw-medium">Gestionar Oficinas</span>
                  <small class="opacity-75">Administrar ubicaciones</small>
                </div>
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Variables JSON para los gráficos -->
{{ dashboard_payload|json_script:"dashboard-data" }}

<!-- Scripts para gráficos -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Obtener datos del JSON
  const dashboardData = JSON.parse(document.getElementById('dashboard-data').textContent);
  
  // Colores del tema
  const colors = {
    primary: '#1e40af',
    primaryLight: '#3b82f6',
    accent: '#0ea5e9',
    success: '#10b981',
    warning: '#f59e0b',
    danger: '#ef4444',
    info: '#06b6d4'
  };

  // Función para obtener colores por estado
  function getStatusColor(status) {
    switch(status) {
      case 'DRAFT': return '#6c757d';
      case 'ASSIGNED': return colors.primary;
      case 'IN_PROGRESS': return colors.warning;
      case 'PENDING_SUPPLIES': return colors.info;
      case 'COMPLETED': return colors.success;
      default: return colors.primary;
    }
  }

  // Gráfico de estados (Doughnut)
  const statusEl = document.getElementById('statusChart');
  if (window.Chart && statusEl && dashboardData.statusData && dashboardData.statusData.length > 0) {
    const statusCtx = statusEl.getContext('2d');
    new Chart(statusCtx, {
      type: 'doughnut',
      data: {
        labels: dashboardData.statusData.map(item => item.display),
        datasets: [{
          data: dashboardData.statusData.map(item => item.value),
          backgroundColor: dashboardData.statusData.map(item => getStatusColor(item.code)),
          borderWidth: 3,
          borderColor: '#ffffff',
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              usePointStyle: true,
              padding: 20,
              font: {
                size: 12
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = dashboardData.statusData.reduce((sum, item) => sum + item.value, 0);
                const percentage = ((context.parsed / total) * 100).toFixed(1);
                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
              }
            }
          }
        },
        animation: {
          animateScale: true,
          duration: 1500
        },
        cutout: '60%'
      }
    });
  }

  // Gráfico de oficinas (Bar horizontal)
  const officeEl = document.getElementById('officeChart');
  if (window.Chart && officeEl && dashboardData.officeData && dashboardData.officeData.length > 0) {
    const officeCtx = officeEl.getContext('2d');
    new Chart(officeCtx, {
      type: 'bar',
      data: {
        labels: dashboardData.officeData.map(item => item.label),
        datasets: [{
          label: 'Tickets',
          data: dashboardData.officeData.map(item => item.value),
          backgroundColor: colors.primaryLight,
          borderColor: colors.primary,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: colors.primary,
            borderWidth: 1
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.1)'
            }
          },
          y: {
            grid: {
              display: false
            }
          }
        },
        animation: {
          duration: 1500,
          easing: 'easeOutQuart'
        }
      }
    });
  }

  // Función para animar números
  function animateNumbers() {
    const numbers = document.querySelectorAll('.metric-value');
    numbers.forEach(number => {
      const target = parseInt(number.textContent);
      let current = 0;
      const increment = target / 50;
      const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
          current = target;
          clearInterval(timer);
        }
        number.textContent = Math.floor(current);
      }, 50);
    });
  }

  // Animación de barras de progreso
  function animateProgressBars() {
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach((bar, index) => {
      setTimeout(() => {
        const targetWidth = (parseInt(bar.getAttribute('aria-valuenow')) / 100) * 100;
        bar.style.width = targetWidth + '%';
      }, index * 200);
    });
  }

  // Ejecutar animaciones
  setTimeout(() => {
    animateNumbers();
    animateProgressBars();
  }, 500);
});
</script>
{% endblock %}
{% extends 'base.html' %}
{% load name_filters %}
{% block title %}{% if ticket.technician_id %}Reasignar{% else %}Asignar{% endif %} requerimiento{% endblock %}
{% block content %}

<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a class="text-decoration-none" href="/tickets/"><i class="bi bi-list-task me-1"></i>Requerimientos</a></li>
    <li class="breadcrumb-item active" aria-current="page">#{{ ticket.id }}</li>
  </ol>
</nav>

<div class="row justify-content-center">
  <div class="col-12 col-lg-7">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-person-plus me-2"></i>{% if ticket.technician_id %}Reasignar{% else %}Asignar{% endif %} técnico</h5>
        <span class="badge {% if ticket.status == 'COMPLETED' %}bg-success{% elif ticket.status == 'IN_PROGRESS' %}bg-primary{% elif ticket.status == 'PENDING_SUPPLIES' %}bg-warning{% else %}bg-secondary{% endif %}">{{ ticket.get_status_display }}</span>
      </div>
      <div class="card-body">
        {% if ticket.status == 'COMPLETED' %}
          <div class="alert alert-info mb-0"><i class="bi bi-info-circle me-1"></i>El requerimiento está completado y no se puede (re)asignar.</div>
        {% else %}
          <div class="mb-3 small text-muted">
            <div><strong>Oficina:</strong> {{ ticket.assigned_office }}</div>
            <div><strong>Actual técnico:</strong> {% if ticket.technician %}<span title="@{{ ticket.technician.username }}">{{ ticket.technician|first_last }}</span>{% else %}<span class="text-secondary">Sin asignar</span>{% endif %}</div>
          </div>
          <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label fw-medium">Seleccionar técnico</label>
              <select name="technician" class="form-select" required>
                <option value="">Elige un técnico…</option>
                <option value="self">Yo (Supervisor)</option>
                {% for u in tecnicos %}
                  <option value="{{ u.id }}">{{ u|first_last }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="d-flex justify-content-end gap-2">
              <a class="btn btn-secondary" href="/tickets/"><i class="bi bi-x-circle me-1"></i>Cancelar</a>
              <button class="btn btn-primary" type="submit"><i class="bi bi-check-circle me-1"></i>Asignar</button>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
